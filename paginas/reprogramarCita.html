<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reprogramar Cita - FisioWelfare</title>
    <link rel="stylesheet" href="../css/panelPaciente.css">
</head>

<body>
    <div class="container">
        <header>
            <h2>Reprogramar Cita</h2>
        </header>
        <main>
            <form id="formReprogramar">
                <label for="fecha">Nueva fecha:</label>
                <input type="date" id="fecha" name="fecha" required>

                <label for="hora">Nueva hora:</label>
                <input type="time" id="hora" name="hora" required>

                <button type="submit" class="btn btn-primary">Guardar cambios</button>
                <button type="button" class="btn btn-secondary" id="btnCancelar">Cancelar</button>
            </form>
        </main>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const urlParams = new URLSearchParams(window.location.search);
            const idCita = urlParams.get("id_cita");
            if (!idCita) {
                alert("No se recibió la cita.");
                window.location.href = "panelPaciente.html";
            }
            localStorage.setItem("usuarioId", usuario.id);

            const form = document.getElementById("formReprogramar");
            const btnCancelar = document.getElementById("btnCancelar");

            // Cancelar
            btnCancelar.addEventListener("click", () => window.location.href = "panelPaciente.html");

            form.addEventListener("submit", (e) => {
                e.preventDefault();

                const fecha = document.getElementById("fecha").value;
                const hora = document.getElementById("hora").value;

                // Validar fecha/hora no pasada
                const hoy = new Date();
                const fechaSeleccionada = new Date(fecha + "T" + hora);
                if (fechaSeleccionada < hoy) {
                    alert("No se puede seleccionar una fecha/hora pasada.");
                    return;
                }

                // Validar horario permitido (08:00 a 18:00)
                const [hh, mm] = hora.split(":").map(Number);
                if (hh < 8 || hh > 18) {
                    alert("La hora debe estar entre 08:00 y 18:00.");
                    return;
                }

                // Verificar conflicto con otras citas del paciente (excluyendo la actual)
                const idPaciente = JSON.parse(localStorage.getItem("usuario")).id;
                fetch(`../BaseDatos/verificarCita.php?id_paciente=${idPaciente}&fecha=${fecha}&hora=${hora}&id_cita_actual=${idCita}`)
                    .then(res => res.json())
                    .then(res => {
                        if (res.existe) {
                            alert("Ya tienes otra cita programada en esa fecha y hora.");
                            return;
                        }

                        // Enviar reprogramación
                        fetch(`../BaseDatos/reprogramarCita.php`, {
                            method: "POST",
                            headers: { "Content-Type": "application/x-www-form-urlencoded" },
                            body: `id_cita=${idCita}&fecha=${fecha}&hora=${hora}`
                        })
                            .then(r => r.json())
                            .then(r => {
                                if (r.success) {
                                    alert("Cita reprogramada correctamente.");
                                    window.location.href = "panelPaciente.html";
                                } else {
                                    alert("Error: " + r.message);
                                }
                            })
                            .catch(err => {
                                console.error(err);
                                alert("Error al reprogramar la cita.");
                            });
                    })
                    .catch(err => {
                        console.error(err);
                        alert("Error al verificar disponibilidad.");
                    });
            });
        });
    </script>
</body>

</html>